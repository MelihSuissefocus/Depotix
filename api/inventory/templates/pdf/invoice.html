{% load invoice_extras %}
<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung {{ invoice.invoice_number }}</title>
    <style>
        {% include "pdf/_styles.css" %}
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-row">
            <!-- Supplier info left -->
            <div class="supplier-info">
                <div>{{ supplier.name|default:"Bi-Swiss GmbH" }} / {{ supplier.street|default:"Eichengasse 3" }} / {{ supplier.postal_code|default:"CH-4702" }} {{ supplier.city|default:"Oensingen" }}</div>
            </div>

            <!-- Logo right -->
            <div class="logo-placeholder">
                {% if logo_data_uri %}
                    <img src="{{ logo_data_uri }}" alt="{{ supplier.name }}" class="logo-img" />
                {% else %}
                    Logo
                {% endif %}
            </div>
        </div>

        <!-- Header line -->
        <div class="header-line"></div>
    </div>

    <!-- Address and meta columns -->
    <div class="address-meta-section">
        <!-- Left column - Address -->
        <div class="left-column">
            <div class="section-title">Adresse</div>
            <div class="address-lines">
                <div>{{ customer.name }}</div>
                {% if customer.contact_name %}
                <div>{{ customer.contact_name }}</div>
                {% endif %}
                {{ customer.address|linebreaksbr }}
            </div>

            <div class="section-title delivery-address">Lieferadresse</div>
            <div class="address-lines">
                <div>{{ customer.name }}</div>
                {% if customer.contact_name %}
                <div>{{ customer.contact_name }}</div>
                {% endif %}
                {% if customer.shipping_address %}
                    {{ customer.shipping_address|linebreaksbr }}
                {% else %}
                    {{ customer.address|linebreaksbr }}
                {% endif %}
            </div>
        </div>

        <!-- Right column - Document info -->
        <div class="right-column">
            <div class="meta-line">
                <span class="meta-label">Dokument Nr.:</span>
                <span class="meta-value">{{ invoice.invoice_number }}</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">Dokument Datum:</span>
                <span class="meta-value">{{ invoice.issue_date|date:"d.m.Y" }}</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">Ihre Kundennr.:</span>
                <span class="meta-value">{{ customer.customer_number }}</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">Lieferdatum:</span>
                <span class="meta-value">{% if invoice.delivery_date %}{{ invoice.delivery_date|date:"d.m.Y" }}{% endif %}</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">Zahlungsmethode:</span>
                <span class="meta-value">Rechnung</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">Zahlbar bis:</span>
                <span class="meta-value">{{ invoice.due_date|date:"d.m.Y" }}</span>
            </div>
            <div class="meta-line">
                <span class="meta-label">MwSt-Nr:</span>
                <span class="meta-value">{{ supplier.mwst_number|default:"CHE-390.391.667 MWST" }}</span>
            </div>
        </div>
    </div>

    <!-- Date line right-aligned -->
    <div style="text-align: right; font-size: 10pt; margin-bottom: 2mm;">
        Oensingen, {{ invoice.issue_date|swiss_date_format }}
    </div>

    <!-- Invoice title -->
    <div style="font-size: 12pt; font-weight: 600; margin-bottom: 2mm;">
        Rechnung {{ invoice.invoice_number }}
    </div>

    <div class="title-line"></div>

    <div class="thank-you-text">
        Wir danken für ihren Auftrag und stellen Ihnen folgende Positionen in Rechnung:
    </div>

    <!-- Items table -->
    <table class="items-table">
        <thead>
            <tr>
                <th class="col-bezeichnung">Bezeichnung</th>
                <th class="col-menge">Menge</th>
                <th class="col-einheit">Einheit</th>
                <th class="col-mwst">MwSt</th>
                <th class="col-preis">Preis</th>
                <th class="col-rabatt">Rabatt</th>
                <th class="col-betrag">Betrag CHF</th>
            </tr>
        </thead>
        <tbody>
            {% for line in lines %}
            <tr>
                <td class="col-bezeichnung">{{ line.name }}</td>
                <td class="col-menge">{{ line.qty_display|floatformat:2 }}</td>
                <td class="col-einheit">{{ line.selected_unit|default:"Verpackung" }}</td>
                <td class="col-mwst">{{ line.tax_rate|floatformat:2 }}%</td>
                <td class="col-preis">{{ line.unit_price|swiss_currency }}</td>
                <td class="col-rabatt">0.00%</td>
                <td class="col-betrag">{{ line.line_total_net|swiss_currency }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="table-bottom-line"></div>

    <!-- Totals section -->
    <div class="totals-section">
        <div class="totals-line">
            <span class="total-label">Total CHF</span>
            <span class="total-value">{{ invoice.total_net|swiss_currency }}</span>
        </div>
        <div class="totals-line">
            <span class="total-label">Total MwSt {{ invoice.vat_rate|floatformat:2 }}% von {{ invoice.total_net|swiss_currency }}</span>
            <span class="total-value">{{ invoice.total_tax|swiss_currency }}</span>
        </div>
        <div class="totals-line">
            <span class="total-label">Total inkl. MwSt CHF</span>
            <span class="total-value">{{ invoice.total_gross|swiss_currency }}</span>
        </div>
    </div>

    <!-- Page break to force payment section to page 2 -->
    <div class="page-break"></div>

    <!-- Payment information -->
    <div class="payment-section">
        <div class="payment-title">Zahlung Bitte an:</div>
        <div class="payment-info">
            <div>{{ supplier.bank_name|default:"Basellandschaftliche Kantonalbank, Liestal" }}</div>
            <div>{{ supplier.iban|default:"CH06 0076 9442 3946 4200 2" }}</div>
        </div>

    </div>

    <!-- Greeting -->
    <div class="greeting-section">
        <div>Für ihr Vertrauen danken wir Ihnen</div>
        <div>Freundliche Grüsse</div>
        <div>{{ supplier.name|default:"Bi-Swiss GmbH" }}</div>
    </div>

    {% if qr_data_uri %}
    <!-- Swiss QR Bill (generated by qrbill library) -->
    <div class="qr-section-inline">
        {{ qr_data_uri|safe }}
    </div>
    {% endif %}

    <!-- Footer - Before QR Bill -->
    <div class="footer footer-page-1">
        <div class="footer-left">{{ supplier.name|default:"Bi-Swiss GmbH" }}  /  {{ supplier.street|default:"Eichengasse 3" }}  /  {{ supplier.postal_code|default:"4207" }} {{ supplier.city|default:"Oensingen" }}</div>
        <div class="footer-center">Telefon {{ supplier.phone|default:"+41 76 840 55 40" }}</div>
        <div class="footer-right">UID MwSt.: {{ supplier.mwst_number|default:"CHE-390.391.667 MWST" }}</div>
    </div>

</body>
</html>